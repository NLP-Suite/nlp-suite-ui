{% extends 'base.html' %}
{% block content %}
{% load static %}

<div class="sentiment-analysis-container">
    <h1>Sunburst Charts</h1>
    <form method="post" class="sentiment-analysis-form" action="{% url 'sunburst_charts' %}">
        {% csrf_token %}

        <!-- Input and Output Directories -->
        <div class="form-row">
            <label for="inputDirectory">Input Directory:</label>
            <input type="text" name="inputDirectory" value="~/nlp-suite/input" />
        </div>
        <div class="form-row">
            <label for="outputDirectory">Output Directory:</label>
            <input type="text" name="outputDirectory" value="~/nlp-suite/output" />
        </div>

        <!-- CSV File Input and Search Field Selection -->
        <div class="form-row">
            <label for="search_field">Search field</label>
            <input type="file" id="sunburst_file_input" name="sunburst_file_input" accept=".csv">
            <select id="search_field" name="search_field">
                <option value="" disabled selected>Select a field</option>
            </select>
        </div>

        <!-- Filter Options Selection -->
        <div class="form-row">
            <label for="filter_options_var">Filter Options</label>
            <select id="filter_options_var" name="filter_options_var">
                <option value="no_filtering">No filtering</option>
                <option value="fixed_parameter">Fixed parameter</option>
                <option value="propagating_parameter">Propagating Parameter</option>
            </select>
        </div>

        <!-- Search Values Input -->
        <div class="form-row">
            <label>
                Search Values
                <span class="tooltip">
                    <span class="tooltiptext">
                        Enter a comma-separated list of specific words or values (minimum of 3). (e.g., the, three, little, pigs)
                    </span>
                </span>
                <input type="text" id="keywordInput" name="keywordInput">
            </label>
        </div>

        <!-- Add and Display Filter Option + CSV Field List Pairs -->
        <h3>Add Filter Option and CSV Field List Pairs</h3>
        <div class="form-row">
            <button type="button" id="add_pair_button">Add Pair</button>
        </div>
        <div class="form-row">
            <label for="saved_pairs">Saved Pairs:</label>
            <div id="saved_pairs_container">
                <!-- Pairs will be dynamically displayed here -->
            </div>
        </div>

        <!-- Chart Options -->
        <div class="form-row">
            <label>
                <input type="checkbox" name="piechart_var" checked>
                Pie chart
            </label>
            <label style="margin-left: 20px;">
                <input type="checkbox" name="treemap_var">
                Tree map chart
            </label>
        </div>

        <!-- Form Buttons -->
        <div class="buttons-section">
            <button type="reset" class="reset-button">Reset</button>
            <button type="submit" class="run-button">Run</button>
        </div>
    </form>
</div>

<!-- JavaScript for Dynamic Functionality -->
<script>
    let selectedFieldValues = []; 
    let savedPairs = [];

    // Existing functionality: Populate dropdown based on uploaded CSV file
    document.getElementById("sunburst_file_input").addEventListener("change", function (event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        
        reader.onload = function () {
            const csvContent = reader.result;
            processCSV(csvContent);
        };
        
        reader.readAsText(file); // Start reading the file
    });

    function processCSV(csvContent) {
        const rows = csvContent.split("\n").map(row => row.split(","));
        if (rows.length < 2) return; // Ensure there's data

        const headers = rows[0];
        const data = rows.slice(1);

        populateDropdown(headers, data);
    }

    function populateDropdown(headers, data) {
        const dropdown = document.getElementById("search_field");
        dropdown.innerHTML = '<option value="" disabled selected>Select a field</option>';

        headers.forEach((header, index) => {
            const option = document.createElement("option");
            option.value = index;
            option.textContent = header.trim();
            dropdown.appendChild(option);
        });

        dropdown.addEventListener("change", function () {
            const selectedIndex = this.value;
            selectedFieldValues = getFieldData(selectedIndex, data); // Update the global array
            //console.log(selectedFieldValues); // Values can be logged for debugging (if necessary)
        });
    }

    function getFieldData(fieldIndex, data) {
        return data.map(row => {
            let cell = row[fieldIndex]; // Get the cell value at the specified column (fieldIndex)
        
            if (cell) {
                cell = cell.replace(/"/g, ""); // Remove all double quotes from the cell
                cell = cell.trim(); // Remove any leading or trailing whitespace
            }
        
            return cell || "(empty)"; // If the cell is empty or undefined, return empty. 
        });
    }
    
    // New functionality: Add Filter Option and CSV Field List Pair
    document.getElementById('add_pair_button').addEventListener('click', function() {
        const searchFieldDropdown = document.getElementById('search_field');
        const csvFieldListInput = document.getElementById('keywordInput');
        const savedPairsContainer = document.getElementById('saved_pairs_container');

        const searchField = searchFieldDropdown.value.trim();
        const csvFieldList = csvFieldListInput.value.trim();

        // Check if CSV Field List contains more than 2 words separated by commas
        const csvFieldWords = csvFieldList.split(',').map(word => word.trim()).filter(word => word.length > 0);
        if (csvFieldWords.length <= 2) {
            alert('The CSV Field List must contain more than 2 words separated by commas.');
            return; // Stop execution if validation fails
        }

        if (searchField && csvFieldList) {
            // Save the pair
            const pair = { searchField, csvFieldList };
            savedPairs.push(pair);

            // Create a checkbox for the pair
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = 'selected_pairs';
            checkbox.value = JSON.stringify(pair);
            checkbox.checked = true;

            const label = document.createElement('label');
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(` ${searchField} - ${csvFieldList}`));

            const div = document.createElement('div');
            div.appendChild(label);

            savedPairsContainer.appendChild(div);

            // Clear the input field for CSV Field List
            csvFieldListInput.value = '';
        } else {
            alert('Please select a Search Field and enter a CSV Field List.');
        }
    });


    // Handle form submission to include saved pairs
    document.querySelector('form').addEventListener('submit', function(event) {
        // Gather selected pairs
        const checkboxes = document.getElementsByName('selected_pairs');
        const selectedPairs = [];
        for (const checkbox of checkboxes) {
            if (checkbox.checked) {
                selectedPairs.push(JSON.parse(checkbox.value));
            }
        }

        // Create a hidden input to store the selected pairs
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'selected_pairs_data';
        hiddenInput.value = JSON.stringify(selectedPairs);
        this.appendChild(hiddenInput);
    });
</script>

<style>
    /* Tooltip styling */
    .tooltip {
        position: relative;
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        margin-left: 10px;
    }

    .tooltip::before {
        content: "?";
        display: inline-block;
        width: 25px;
        height: 25px;
        background-color: white;
        color: #4caf50;
        border: 2px solid #9ee4a0;
        border-radius: 50%;
        text-align: center;
        line-height: 25px;
        font-size: 16px;
        font-weight: bold;
    }

    .tooltip .tooltiptext {
        visibility: hidden;
        width: 300px;
        background-color: #555;
        color: #fff;
        border-radius: 5px;
        padding: 10px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -150px;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
    }

    .form-row {
        margin-bottom: 15px;
    }

    .buttons-section {
        margin-top: 20px;
    }

    .reset-button, .run-button {
        padding: 10px 20px;
        margin-right: 10px;
    }
</style>

{% endblock %}
